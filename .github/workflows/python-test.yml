# ğŸ§ª CI/CD å·¥ä½œæµç¨‹ï¼šåŸ·è¡Œ Python æ¸¬è©¦ä¸¦éƒ¨ç½² Coverage HTML å ±å‘Šåˆ° GitHub Pages
name: Python Test and Deploy Coverage

# ğŸ“Œ è§¸ç™¼æ¢ä»¶ï¼š
# ç•¶æœ‰ push æˆ– pull request ç™¼ç”Ÿåœ¨ main åˆ†æ”¯æ™‚ï¼ŒåŸ·è¡Œæœ¬æµç¨‹
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# ğŸ” æ¬Šé™è¨­å®šï¼ˆGitHub Pages éœ€è¦ pages èˆ‡ id-token æ¬Šé™ï¼‰
permissions:
  contents: read        # è®€å–ç¨‹å¼ç¢¼
  pages: write          # å¯«å…¥ GitHub Pages
  id-token: write       # èº«åˆ†é©—è­‰ä»¤ç‰Œï¼Œç”¨æ–¼ GitHub Pages æˆæ¬Š

# ğŸš¦ é™åˆ¶åŒæ™‚é–“åªèƒ½åŸ·è¡Œä¸€å€‹éƒ¨ç½²æµç¨‹ï¼ˆé¿å…å¤šé‡éƒ¨ç½²è¡çªï¼‰
concurrency:
  group: "pages"        # å°‡åŒä¸€é¡å‹å·¥ä½œæ­¸ç‚ºåŒä¸€çµ„
  cancel-in-progress: true  # æœ‰æ–°æµç¨‹å•Ÿå‹•æ™‚ï¼Œå–æ¶ˆæ­£åœ¨åŸ·è¡Œçš„èˆŠæµç¨‹

# ğŸ§© ä¸»æµç¨‹å€å¡Š
jobs:
  test_and_deploy:
    runs-on: ubuntu-latest  # æŒ‡å®šåŸ·è¡Œç’°å¢ƒç‚ºæœ€æ–°ç‰ˆ Ubuntu

    # ğŸ”— å®£å‘Šéƒ¨ç½²ç’°å¢ƒç‚º GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}  # è¨­å®šéƒ¨ç½²å®Œæˆå¾Œçš„é é¢ URL

    steps:
      # âœ… æ­¥é©Ÿ 1ï¼šæ‹‰å–åŸå§‹ç¢¼
      - name: Checkout code
        uses: actions/checkout@v4  # ä½¿ç”¨å®˜æ–¹ checkout å¥—ä»¶æ‹‰å– Git å„²å­˜åº«å…§å®¹

      # ğŸ æ­¥é©Ÿ 2ï¼šå®‰è£ Python ç’°å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # æŒ‡å®š Python ç‰ˆæœ¬ç‚º 3.11

      # ğŸ“¦ æ­¥é©Ÿ 3ï¼šå®‰è£ Python å¥—ä»¶ï¼ˆå¾ requirements.txtï¼‰
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip         # æ›´æ–° pip è‡³æœ€æ–°ç‰ˆ
          pip install -r requirements.txt             # å®‰è£å°ˆæ¡ˆæ‰€éœ€ä¾è³´

      # ğŸ§ª æ­¥é©Ÿ 4ï¼šåŸ·è¡Œ pytest æ¸¬è©¦ä¸¦ç”¢ç”Ÿ coverage HTML å ±å‘Š
      - name: Run tests and generate coverage
        run: |
          mkdir -p reports/htmlcov                    # å»ºç«‹å ±å‘Šè¼¸å‡ºè³‡æ–™å¤¾
          pytest --cov=. --cov-report=html:reports/htmlcov
          # ä½¿ç”¨ pytest-cov ç”¢å‡º HTML æ ¼å¼çš„ coverage å ±å‘Šåˆ°æŒ‡å®šè³‡æ–™å¤¾

      # ğŸŒ æ­¥é©Ÿ 5ï¼šè¨­å®š GitHub Pages ç™¼ä½ˆè³‡è¨Š
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4              # ä½¿ç”¨æ–°ç‰ˆ GitHub Pages è¨­å®š action

      # ğŸ—ƒï¸ æ­¥é©Ÿ 6ï¼šå°‡ coverage HTML å ±å‘Šæ‰“åŒ…ä¸Šå‚³ç‚º GitHub Pages çš„ artifact
      - name: Upload coverage HTML to GitHub Pages
        uses: actions/upload-pages-artifact@v3        # ä¸Šå‚³çµ¦ Pages ç”¨çš„ç‰¹å®š actionï¼ˆä¸æ˜¯ upload-artifactï¼‰
        with:
          path: reports/htmlcov                       # æŒ‡å®šè¦ä¸Šå‚³çš„ coverage è·¯å¾‘ï¼ˆéœ€èˆ‡ä¸Šæ–¹ç”¢å‡ºè·¯å¾‘ä¸€è‡´ï¼‰

      # ğŸš€ æ­¥é©Ÿ 7ï¼šå¯¦éš›å°‡å ±å‘Šéƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        id: deploy                                    # æŒ‡å®š IDï¼Œä»¥ä¾¿å¾ŒçºŒå¼•ç”¨ URL
        uses: actions/deploy-pages@v4                 # ä½¿ç”¨æ–°ç‰ˆ deploy-pages å®Œæˆéƒ¨ç½²
